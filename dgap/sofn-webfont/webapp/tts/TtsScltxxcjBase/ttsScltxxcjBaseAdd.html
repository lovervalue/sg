<!--<script type="text/javascript" src="assets/js/tts/register/maps.js"></script>-->
<!--<script type="text/javascript" src="assets/js/tts/register/service.js"></script>-->
<script type="text/javascript" src="http://api.tianditu.com/js/maps.js"></script>
<script type="text/javascript" src="http://api.tianditu.com/js/service.js"></script>
<div class="gui-breadcrumbs">
    <a href="">内部管理</a>&gt;
    <a href="">基地管理</a>&gt;
    <span>新增</span>
</div>
<div class="gui-section">
    <form id="attributeForm" class="form-horizontal" data-bv-excluded="" data-bv-message="不能为空">
        <div class="ovh">
            <ul class="gui-list clearfix">
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地名称</label>
                        <input type="text" ng-model="ttsScltxxcjBase.name" name="name" placeholder="请输入基地名称" class="gui-input form-control" data-bv-notempty="true" data-bv-notempty-message="内容不能是空" data-bv-stringlength="true" data-bv-stringlength-min="1" data-bv-stringlength-max="30" data-bv-stringlength-message="基地名称必须超过1，不超过30个字符">
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">所属区域</label>
                        <div class="text-field">
                            <div class="gui-select" style="width:auto;">
                                <select id="sheng">
                                    <option value="">--请选择省份--</option>
                                </select>
                            </div>
                            <div class="gui-select" style="width:auto;">
                                <select id="shi">
                                    <option value="">--请选择市份--</option>
                                </select>
                            </div>
                            <div class="gui-select" style="width:auto;">
                                <select id="xian">
                                    <option value="">--请选择区县--</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地详细地址</label>
                        <input type="text" ng-model="ttsScltxxcjBase.address" id="address" name="address" placeholder="请输入基地详细地址" class="gui-input form-control" data-bv-notempty="true" data-bv-notempty-message="内容不能是空" data-bv-stringlength="true" data-bv-stringlength-min="1" data-bv-stringlength-max="100" data-bv-stringlength-message="基地详细地址必须超过1，不超过100个字">
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">经纬度</label>
                        <input type="text" class="gui-input form-control" style="width:auto;" id="lonLatName" ng-model="lonLatName" name="lonLatName" placeholder="请输入经纬度名称" readonly onclick="gis()">
                        <input type="text" class="gui-input form-control" style="width:auto;" id="lon" ng-model="ttsScltxxcjBase.longitude" name="lon" placeholder="请输入经度" readonly onclick="gis()">
                        <input type="text" class="gui-input form-control" style="width:auto;" id="lat" ng-model="ttsScltxxcjBase.latitude" name="lat" placeholder="请输入纬度" readonly onclick="gis()">
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地面积</label>
                        <input type="text" ng-model="ttsScltxxcjBase.area" name="area" placeholder="请输入基地面积" class="gui-input form-control" data-bv-notempty="true" data-bv-notempty-message="内容不能是空" data-bv-integer="true" data-bv-min="0" data-bv-integer-message="请输入整数">&nbsp;亩
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地负责人</label>
                        <input type="text" ng-model="ttsScltxxcjBase.manager" name="manager" placeholder="请输入基地负责人姓名" class="gui-input form-control" data-bv-notempty="true" data-bv-notempty-message="内容不能是空" data-bv-regexp="true" data-bv-regexp-regexp="[\u4e00-\u9fa5]" data-bv-regexp-message="基地负责人只能由汉字组成" data-bv-stringlength="true" data-bv-stringlength-min="2" data-bv-stringlength-max="10" data-bv-stringlength-message="基地负责人姓名必须超过2，不超过10个字符">
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">联系方式</label>
                        <input type="text" ng-model="ttsScltxxcjBase.phone" name="phone" placeholder="请输入基地联系方式" class="gui-input form-control" data-bv-notempty="true" data-bv-notempty-message="内容不能是空" data-bv-isphone="true" data-bv-isphone-message="请输入有效的手机号码">
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地状态</label>
                        <div class="gui-select">
                            <select name="status">
                                <option value="">请选择</option>
                                <option selected="selected" value="Y">启用</option>
                                <option value="N">停用</option>
                            </select>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="form-item form-group">
                        <label class="title control-label">基地图片</label>
                        <div class="text-field">
                            <img id="yulan-1" ng-click="showUpload1()" alt="点击上传图片" ng-model="ttsScltxxcjBase.picture" class="mr15" name="picture" src="../../../images/baseImage/noDelete.jpg" height="100" width="100">
                            <img id="yulan-2" ng-click="showUpload2()" alt="点击上传图片" src="../../../images/baseImage/noDelete.jpg" ng-model="ttsScltxxcjBase.pictureTwo" name="pictureTwo" height="100" width="100">
                        </div>
                </div></li>
            </ul>
            </div>
        </form></div>
        <div class="text-center">
            <button class="gui-btn" ui-sref="index.content.tts/TtsScltxxcjBase/TtsScltxxcjBaselist">取消</button>
            <button class="gui-btn" ng-disabled="myform.JGname.$dirty&&myform.JGname.$invalid" ng-click="addTtsScltxxcjBase()">提交</button>
        </div>
    
    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-stylesm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel1">基地图片上传</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <form enctype="multipart/form-data">
                            <input style="display: inline;width: 225px" id="file-1" multiple="true" data-overwrite-initial="false" data-min-file-count="1" data-max-file-count="1" type="file">
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="gui-btn">保存</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-stylesm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title" id="myModalLabel2">基地图片上传</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <form enctype="multipart/form-data">
                            <input style="display: inline;width: 225px" id="file-2" multiple="true" data-overwrite-initial="false" data-min-file-count="1" data-max-file-count="1" type="file">
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="gui-btn">保存</button>
                </div>
            </div>
        </div>
    </div>


<!-- map -->
<!-- 弹出层 -->
<div class="modal fade" id="gis" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width:1000px; height:500px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">经纬度</h4>
            </div>
            <div class="modal-body" style="padding: 0px 2px;">
                <div id="mapDiv" style="width:700px; height:500px;"></div>
                <div style="position: absolute;left: 730px;top: 15px;bottom: 15px;width: 253px;overflow: auto">
                    <!-- 搜索面板 -->
                    <div class="search">搜索内容：</div>
                    <!-- 提示词面板 -->
                    <div id="promptDiv" class="prompt"></div>
                    <!-- 统计面板 -->
                    <div id="statisticsDiv" class="statistics"></div>
                    <!-- 建议词面板 -->
                    <div id="suggestsDiv" class="suggests"></div>
                    <!-- 公交提示面板 -->
                    <div id="lineDataDiv" class="lineData" ></div>
                    <!-- 搜索结果面板 -->
                    <div id="resultDiv" class="result" style="display:none">
                        <div id="searchDiv"></div>
                        <div id="pageDiv">
                            <button class="gui-btn btn-small mb15" onclick="localsearch.firstPage()">首页</button>
                            <button class="gui-btn btn-small mb15" onclick="localsearch.previousPage()">上页</button>
                            <button class="gui-btn btn-small mb15" onclick="localsearch.nextPage()">下页</button>
                            <button class="gui-btn btn-small mb15" onclick="localsearch.lastPage()">尾页</button>
                            <br>转到第
                            <input class="gui-input mb15" type="text" id="pageId" style="width:120px;">页
                            <button class="gui-btn btn-small mb15" onclick="localsearch.gotoPage(parseInt(document.getElementById('pageId').value));">跳转</button>
                        </div>
                    </div>
                    <!-- 无搜索结果面板 -->
                    <div id="noResultDiv" class="result" style="display:none">没有搜索到相关的结果。</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="gui-btn" data-dismiss="modal">保存</button>
            </div>
        </div>
    </div>
</div>

<div id="toolbar" style="height:32px;border-top: 0px solid #999999;border-bottom: 1px solid #999999;min-width: 700px;background-color: white;display: none;">
    <div style="float:left; display:inline; line-height:25px;">
        <div id="areaCity" style="float: left;display: inline;line-height: 26px;">
            <span class="title">所属区域</span>：
            <select class="gui-select" id="provsel" style="width:60px;height: 26px;margin-right: 2px;" ochange="doChangeArea(1)"><option value="">--省份--</option></select>
            <select class="gui-select" id="citysel" style="width:60px;height: 26px;margin-right: 2px;" onchange="doChangeArea(2)"><option value="">--市区--</option></select>
            <select class="gui-select" id="areasel" style="width:60px;height: 26px;margin-right: 2px;" onchange="doChangeArea(3)"><option value="">--区/县--</option></select>
        </div>
    </div>
    <div style="float: right;display: inline;line-height: 26px;margin-top:0px;margin-right:5px;">
        <div class="input-group">
            <input type="text" class="gui-input mb15" id="keyWord" value="" style="width:200px;height: 26px;" placeholder="关键字搜索">
            <button class="gui-btn btn-small mb15" onclick="doLocalSearch($('#keyWord').val())">搜索</button>
            <button class="gui-btn btn-small mb15" onclick="addTMarker()">标记</button>
        </div>
    </div>
</div>

<div id="lngLatv" style="display: none;font-family:宋体;font-size: 12px;">
    经度：<span id="lngv"></span>&nbsp;纬度：<span id="latv"></span>
</div>

<!--<div class="modal fade" id="gis" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"-->
<!--aria-hidden="true" style="background-color: white">-->
<!-- -->
<!-- -->
<!--</div>-->
<script>

    //地图GIS
    var map;
    var zoom = 12;
    var localsearch;
    var geocode;

    function onLoad() {
        //初始化地图对象
        map = new TMap("mapDiv");
        //设置显示地图的中心点和级别
        map.centerAndZoom(new TLngLat(116.40969, 39.89945), zoom);
        //允许鼠标滚轮缩放地图
        map.enableHandleMouseScroll();
        //允许双击地图放大
        map.enableDoubleClickZoom();
        //允许地图惯性拖拽
        map.enableInertia();
        //允许键盘操作
        map.enableHandleKeyboard();

        var opts = {
            pageCapacity: 12, //每页显示的数量
            onSearchComplete: localSearchResult //接收数据的回调函数
        };
        //创建搜索对象
        localsearch = new TLocalSearch(map, opts);
        geocode = new TGeocoder();

        //创建自定义控件，并添加到地图上
        var toolbarHtml = document.getElementById("toolbar");
        var toolbarControl = new THtmlElementControl(toolbarHtml);
        toolbarControl.setLeft(0);
        toolbarControl.setTop(0);
        map.addControl(toolbarControl);
        document.getElementById("toolbar").style.display = "block";

        //经纬度动态显示
        var lngLatHtml = document.getElementById("lngLatv");
        var lngLatControl = new THtmlElementControl(lngLatHtml);
        lngLatControl.setRight(10);
        lngLatControl.setBottom(5);
        map.addControl(lngLatControl);
        document.getElementById("lngLatv").style.display = "block";

        //添加骨头棒控件，可以缩放和移动地图
        var config = {
            type : "TMAP_NAVIGATION_CONTROL_LARGE",
            anchor : "TMAP_ANCHOR_TO_LEFT",
            offset : [0,0],
            showZoomInfo : true
        };
        var control = new TNavigationControl(config);
        control.setTop(50);
        map.addControl(control);

        //注册地图事件
        TEvent.addListener(map, "mousemove", function(pixel){
            var lnglat=map.fromContainerPixelToLngLat(pixel);
            $("#lngv").html(lnglat.getLng());
            $("#latv").html(lnglat.getLat());
        });

    }

    //打开事件是否已执行过一次
    var isTged2showEvt =  false;
    //关闭事件是否已执行过一次
    var isTged2hideEvt =  false;
    //行政区域数据是否已初始化(初始化期间不执行联动change事件)
    var isTged2initEvt =  false;
    //地图展示
    function gis() {
        //初始化事件参数
        isTged2showEvt =  false;
        isTged2hideEvt =  false;
        isTged2initEvt =  false;
        $("#gis").on('shown.bs.modal', function(){//当模态框对用户可见时触发（将等待 CSS 过渡效果完成）。
            //alert("是否已打开处理："+isTged2showEvt);
            if(isTged2showEvt){//防止事件多次监听重复处理[即限定每次打开只做一次监听处理]
                return;
            }

            //alert("开始打开处理");
            isTged2showEvt = true;
            if(isExistMap()){
                //地图自适合大小调整
                map.checkResize();
            }else{
                //初始化图层
                onLoad();
            }
            //初始化行政区域
            initArea();

            //当前地图信息展示
            var lngLatName = $("#lonLatName").val();
            var lng = $("#lon").val();
            var lat = $("#lat").val();
            if(lng && lat ){
                var lnglat = new TLngLat(lng, lat);
                //恢复当前地图中心点和级别(默认16)
                map.panTo(lnglat,16);
                //创建标注对象
                var marker = new TMarker(lnglat);
                //标注可拽
                marker.enableDragging();
                //地图上添加标注点
                map.addOverLay(marker);
                //坐标解析
                geocode.getLocation(lnglat,function(result){
                    geocodeResult(result,marker);
                });
                //事件注册
                TEvent.addListener(marker, "dragstart", function(lnglat){
                    marker.closeInfoWindow();
                });
                TEvent.addListener(marker, "drag", function(lnglat){
                    $("#lngv").html(lnglat.getLng());
                    $("#latv").html(lnglat.getLat());
                });
                TEvent.addListener(marker, "dragend", function(lnglat){
                    geocode.getLocation(lnglat,function(result){
                        geocodeResult(result,marker);
                    });
                });
            }else{
                //默认搜索关键字
                $("#keyWord").val(($("#address").val()||""));
                //初始定位
                doLocalSearch();
            }
        }).on('hide.bs.modal', function(){
            //alert("是否已关闭处理："+isTged2hideEvt);
            if(isTged2hideEvt){//防止事件多次监听重复处理[即限定每次关闭只做一次监听处理]
                return;
            }
            //alert("开始关闭处理");
            isTged2hideEvt = true;
            //回填行政区域数据
            callBackArea();
            //清空地图及搜索列表
            clearAll();

        }).modal("show");
    }

    //初始化行政区域
    function initArea(){
        $.fn.mycity("provsel","citysel","areasel");
        $("#provsel").val($("#sheng option:selected").val()||"");
        $("#provsel").trigger("change");
        $("#citysel").val($("#shi option:selected").val()||"");
        $("#citysel").trigger("change");
        $("#areasel").val($("#xian option:selected").val()||"");
        //初始化结束打开触发事件
        isTged2initEvt=true;
    }

    //回填区域数据
    function callBackArea(){
        if($("#mapDiv").data("lon")){
            var callBackInf = "您已选择："
                    + "\n\n地点：" + $("#mapDiv").data("lonLatName")
                    + "\n经纬度：" + $("#mapDiv").data("lon") + ", " + $("#mapDiv").data("lat")
                    + "\n地址：" + $("#mapDiv").data("address")
                    + "\n\n是否确定退出！"
            alert(callBackInf);
            $("#sheng").val($("#provsel option:selected").val()||"");
            $("#sheng").trigger("change");
            $("#shi").val($("#citysel option:selected").val()||"");
            $("#shi").trigger("change");
            $("#xian").val($("#areasel option:selected").val()||"");
            $("#lon").val($("#mapDiv").data("lon"));
            $("#lat").val($("#mapDiv").data("lat"));
            $("#lonLatName").val($("#mapDiv").data("address"));
            //$("#lonLatName").val($("#mapDiv").data("lonLatName"));
            //$("#address").val($("#mapDiv").data("address"));
        }else{
            alert("尚未选择经纬度是否退出！");
        }

    }

    function addTMarker(){
        //创建标注对象
        var marker = new TMarker(map.getCenter());
        //标注可拽
        marker.enableDragging();
        //地图上添加标注点
        map.addOverLay(marker);
        //事件注册
        TEvent.addListener(marker, "dragstart", function(lnglat){
            marker.closeInfoWindow();
        });
        TEvent.addListener(marker, "drag", function(lnglat){
            $("#lngv").html(lnglat.getLng());
            $("#latv").html(lnglat.getLat());
        });
        TEvent.addListener(marker, "dragend", function(lnglat){
            geocode.getLocation(lnglat,function(result){
                geocodeResult(result,marker);
            });
        });
    }

    /**
     * 占位处理
     */
    function str2format(str,arg){
        if(arg instanceof Array){
            for(var i=0;i<arg.length;i++) {
                str=str.replace(new RegExp("\\{"+i+"\\}","g"),arg[i]);
            }
        }
        return str;
    }

    function doChangeArea(type){
        if(!isTged2initEvt){
            //alert("-未打开不执行-"+type);
            return;
        }
        switch (type) {
            case 1:
                //省级
                var provVal = $("#provsel option:selected").val(), provTxt = $('#provsel option:selected').text();
                if( !provVal||(provTxt.indexOf("请选择")>-1)){
                    provTxt = "";
                }
                localsearch.search(provTxt);
                break;
            case 2:
                //城市级
                var provVal = $("#provsel option:selected").val(), provTxt = $('#provsel option:selected').text();
                if( !provVal||(provTxt.indexOf("请选择")>-1)){
                    provTxt = "";
                }
                var cityVal = $("#citysel option:selected").val(), cityTxt = $('#citysel option:selected').text();
                if( !cityVal||(cityTxt==="市辖区")||(cityTxt==="县")||(cityTxt.indexOf("请选择")>-1)){
                    cityTxt = "";
                }
                localsearch.search(provTxt+cityTxt);
                break;
            case 3:
                //区/县级
                doLocalSearch();
                break;
        }
    }

    function doLocalSearch(keyword){
        var searchTxt = "";
        if(!keyword){
            var provVal = $("#provsel option:selected").val(), provTxt = $('#provsel option:selected').text();
            if( !provVal||(provTxt.indexOf("请选择")>-1)){
                provTxt = "";
            }
            var cityVal = $("#citysel option:selected").val(), cityTxt = $('#citysel option:selected').text();
            if( !cityVal||(cityTxt==="市辖区")||(cityTxt==="县")||(cityTxt.indexOf("请选择")>-1)){
                cityTxt = "";
            }
            var areaVal = $("#areasel option:selected").val(), areaTxt = $('#areasel option:selected').text();
            if( !areaVal||(areaTxt==="市辖区")||(areaTxt.indexOf("请选择")>-1)){
                areaTxt = "";
            }
            searchTxt = provTxt + cityTxt + areaTxt;
        }else{
            searchTxt = keyword || "";
        }
        localsearch.search(searchTxt);
    }

    function geocodeResult(result,marker) {
        //反坐标解析
        var poi="",lacPoint="", address="";
        if(result.getStatus() == 0) {
            var addressCompt = result.getAddressComponent();
            poi = addressCompt.poi;
            address = result.getAddress();
            lacPoint = result.getLocationPoint();
            getLngLat(poi,lacPoint.getLng(),lacPoint.getLat(),address);
        }else{
            result.getMsg();
        }
        showPosition(marker, poi, address);
        //区域反查询
        var mapBounds = map.getBounds();
        var lonlatWest = mapBounds.getSouthWest();
        var lonlatEast = mapBounds.getNorthEast();
        var remoteReqStr = "{"
                + "'lonlat':  '{0},{1}',"
                + "'level': '5',"
                + "'bound': '{2},{3},{4},{5}',"
                + "'zoom': '{6}',"
                + "'layers': ''," //map.getLayers()
                + "'projection': ''"
                + "}";
        remoteReqStr = str2format(remoteReqStr,[
            lacPoint.getLng(),lacPoint.getLat(),
            lonlatWest.getLng(),lonlatWest.getLat(),lonlatEast.getLng(),lonlatEast.getLat(),
            map.getZoom()
        ])
        //alert(remoteReqStr);
        $.post("http://map.tianditu.com/query.shtml",
                {  type: "changeCity",
                    postStr: remoteReqStr
                },
                function(data){
                    if(data){
                        var gbcode = data.gbcode||"";
                        if(gbcode.length==9){
                            var countyCode = gbcode.substring(0,3);
                            if(countyCode=='156'){//中国
                                var provCode=gbcode.substring(3,5);
                                var cityCode=gbcode.substring(5,7);
                                var areaCode=gbcode.substring(7,9);
                                isTged2initEvt=false;
                                $("#provsel").val(provCode);
                                $("#provsel").trigger("change");
                                $("#citysel").val(provCode+cityCode);
                                $("#citysel").trigger("change");
                                $("#areasel").val(provCode+cityCode+areaCode);
                                isTged2initEvt=true;
                            }else{
                                isTged2initEvt=false;
                                $("#provsel").val("");
                                $("#provsel").trigger("change");
                                isTged2initEvt=true;
                            }
                        }
                    }
                },
                "json");
    }

    function localSearchResult(result) {
        //清空地图及搜索列表
        clearAll();

        //添加提示词
        prompt(result);

        ///alert(parseInt(result.getResultType()));
        //根据返回类型解析搜索结果
        switch (parseInt(result.getResultType())) {
            case 1:
                //解析点数据结果
                pois(result.getPois());
                break;
            case 2:
                //解析推荐城市
                statistics(result.getStatistics());
                break;
            case 3:
                //解析行政区划边界
                area(result.getArea());
                break;
            case 4:
                //解析建议词信息
                suggests(result.getSuggests());
                break;
            case 5:
                //解析公交信息
                lineData(result.getLineData());
                break;
        }

    }

    //解析提示词
    function prompt(obj) {
        var prompts = obj.getPrompt();
        if (prompts) {
            var promptHtml = "";
            for (var i = 0; i < prompts.length; i++) {
                var prompt = prompts[i];
                var promptType = prompt.type;
                var promptAdmins = prompt.admins;
                var meanprompt = prompt.DidYouMean;
                if (promptType == 1) {
                    promptHtml += "<p>您是否要在" + promptAdmins[0].name + "</strong>搜索更多包含<strong>" + obj.getKeyword() + "</strong>的相关内容？<p>";
                } else if (promptType == 2) {
                    promptHtml += "<p>在<strong>" + promptAdmins[0].name + "</strong>没有搜索到与<strong>" + obj.getKeyword() + "</strong>相关的结果。<p>";
                    if (meanprompt) {
                        promptHtml += "<p>您是否要找：<font weight='bold' color='#035fbe'><strong>" + meanprompt + "</strong></font><p>";
                    }
                } else if (promptType == 3) {
                    promptHtml += "<p style='margin-bottom:3px;'>有以下相关结果，您是否要找：</p>"
                    for (i = 0; i < promptAdmins.length; i++) {
                        promptHtml += "<p>" + promptAdmins[i].name + "</p>";
                    }
                }
            }
            if (promptHtml != "") {
                document.getElementById("promptDiv").style.display = "block";
                document.getElementById("promptDiv").innerHTML = promptHtml;
            }
        }else{
            document.getElementById("noResultDiv").style.display = "block";
        }
    }

    //获取经纬度方法
    function getLngLat(name, lon, lat, address) {
        map.panTo(new TLngLat(lon, lat),16);
        $("#lngv").html(lon);
        $("#latv").html(lat);
        $("#mapDiv").data("lon",lon);
        $("#mapDiv").data("lat",lat);
        $("#mapDiv").data("lonLatName",name);
        $("#mapDiv").data("address",address);
        $("#mapDiv").data("zoom",map.getZoom());
    }

    //解析点数据结果
    function pois(obj) {
        if (obj) {
            //显示搜索列表
            var divMarker = document.createElement("div");
            //坐标数组，设置最佳比例尺时会用到
            var zoomArr = [];
            for (var i = 0; i < obj.length; i++) {
                //闭包
                (function(i) {
                    //名称
                    var name = obj[i].name;
                    //地址
                    var address = obj[i].address;
                    //坐标
                    var lnglatArr = obj[i].lonlat.split(" ");
                    var lnglat = new TLngLat(lnglatArr[0], lnglatArr[1]);
                    var winHtml = "地址:" + address;
                    //创建标注对象
                    var marker = new TMarker(lnglat);
                    //地图上添加标注点
                    map.addOverLay(marker);
                    //注册标注点的点击事件
                    TEvent.bind(marker, "click", marker, function() {
                        geocode.getLocation(lnglat,function(result){
                            geocodeResult(result,marker);
                        });
                    });
                    zoomArr.push(lnglat);

                    //在页面上显示搜索的列表
                    var a = document.createElement("a");
                    a.href = "JavaScript:void(0);";
                    a.innerHTML = name;
                    a.onclick = function() {
                        geocode.getLocation(lnglat,function(result){
                            geocodeResult(result,marker);
                        });
                    }
                    divMarker.appendChild(document.createTextNode((i + 1) + "."));
                    divMarker.appendChild(a);
                    divMarker.appendChild(document.createElement("br"));
                })(i);
            }
            //显示地图的最佳级别
            map.setViewport(zoomArr);
            //显示搜索结果
            divMarker.appendChild(document.createTextNode('共' + localsearch.getCountNumber() + '条记录，分' + localsearch.getCountPage() + '页,当前第' + localsearch.getPageIndex() + '页'));
            document.getElementById("searchDiv").appendChild(divMarker);
            document.getElementById("resultDiv").style.display = "block";
        }else{
            document.getElementById("noResultDiv").style.display = "block";
        }
    }

    //显示信息框
    function showPosition(marker, name, address) {
        var posHtml = "详细地址：" + address;
        var tipsWin = marker.openInfoWinHtml(posHtml);
        tipsWin.setTitle(name);
    }

    //解析推荐城市
    function statistics(obj) {
        if (obj) {
            //坐标数组，设置最佳比例尺时会用到
            var pointsArr = [];
            var priorityCitysHtml = "";
            var allAdminsHtml = "";
            var priorityCitys = obj.priorityCitys;
            if (priorityCitys) {
                //推荐城市显示
                priorityCitysHtml += "在中国以下城市有结果<ul>";
                for (var i = 0; i < priorityCitys.length; i++) {
                    priorityCitysHtml += "<li>" + priorityCitys[i].name + "(" + priorityCitys[i].count + ")</li>";
                }
                priorityCitysHtml += "</ul>";
            }

            var allAdmins = obj.allAdmins;
            if (allAdmins) {
                allAdminsHtml += "更多城市<ul>";
                for (var i = 0; i < allAdmins.length; i++) {
                    allAdminsHtml += "<li>" + allAdmins[i].name + "(" + allAdmins[i].count + ")";
                    var childAdmins = allAdmins[i].childAdmins;
                    if (childAdmins) {
                        for (var m = 0; m < childAdmins.length; m++) {
                            allAdminsHtml += "<blockquote>" + childAdmins[m].name + "(" + childAdmins[m].count + ")</blockquote>";
                        }
                    }
                    allAdminsHtml += "</li>"
                }
                allAdminsHtml += "</ul>";
            }
            document.getElementById("statisticsDiv").style.display = "block";
            document.getElementById("statisticsDiv").innerHTML = priorityCitysHtml + allAdminsHtml;
        }
    }

    //解析行政区划边界
    function area(obj) {
        if (obj) {
            var level = obj.level;
            var lonlatStr = obj.lonlat;
            var loglatArr = lonlatStr.split(",");
            var loglat = new TLngLat(loglatArr[0], loglatArr[1]);
            //坐标数组，设置最佳比例尺时会用到
            var pointsArr = [];
            var points = obj.points;
            for (var i = 0; i < points.length; i++) {
                var regionLngLats = [];
                var regionArr = points[i].region.split(",");
                for (var m = 0; m < regionArr.length; m++) {
                    var lnglatArr = regionArr[m].split(" ");
                    var lnglat = new TLngLat(lnglatArr[0], lnglatArr[1]);
                    regionLngLats.push(lnglat);
                    pointsArr.push(lnglat);
                }
                //创建线对象
                var line = new TPolyline(regionLngLats, {
                    strokeColor: "blue",
                    strokeWeight: 3,
                    strokeOpacity: 1,
                    strokeStyle: "dashed"
                });
                //向地图上添加线
                //map.addOverLay(line);
            }
            //显示最佳比例尺
            map.setViewport(pointsArr);
            map.panTo(loglat,parseInt(level));
        }
    }


    //解析建议词信息
    function suggests(obj) {
        if (obj) {
            //建议词提示，如果搜索类型为公交规划建议词或公交站搜索时，返回结果为公交信息的建议词。
            var suggestsHtml = "建议词提示<ul>";
            for (var i = 0; i < obj.length; i++) {
                suggestsHtml += "<li>" + obj[i].name + "&nbsp;&nbsp;<font style='color:#666666'>" + obj[i].address + "</font></li>";
            }
            suggestsHtml += "</ul>";
            document.getElementById("suggestsDiv").style.display = "block";
            document.getElementById("suggestsDiv").innerHTML = suggestsHtml;
        }
    }

    //解析公交信息
    function lineData(obj) {
        if (obj) {
            //公交提示
            var lineDataHtml = "公交提示<ul>";
            for (var i = 0; i < obj.length; i++) {
                lineDataHtml += "<li>" + obj[i].name + "&nbsp;&nbsp;<font style='color:#666666'>共" + obj[i].stationNum + "站</font></li>";
            }
            lineDataHtml += "</ul>";
            document.getElementById("lineDataDiv").style.display = "block";
            document.getElementById("lineDataDiv").innerHTML = lineDataHtml;
        }
    }

    //是否已存在地图
    function isExistMap() {
        var mapDiv = document.getElementById("mapDiv").innerHTML;
        if( !map || !mapDiv ){
            return false;
        }
        return true;
    }

    //清空地图及搜索列表
    function clearAll() {
        map&&map.clearOverLays();
        document.getElementById("keyWord").innerHTML = "";
        document.getElementById("searchDiv").innerHTML = "";
        document.getElementById("resultDiv").style.display = "none";
        document.getElementById("noResultDiv").style.display = "none";
        document.getElementById("statisticsDiv").innerHTML = "";
        document.getElementById("statisticsDiv").style.display = "none";
        document.getElementById("promptDiv").innerHTML = "";
        document.getElementById("promptDiv").style.display = "none";
        document.getElementById("suggestsDiv").innerHTML = "";
        document.getElementById("suggestsDiv").style.display = "none";
        document.getElementById("lineDataDiv").innerHTML = "";
        document.getElementById("lineDataDiv").style.display = "none";
    }

</script>
